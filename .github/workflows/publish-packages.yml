name: Publish Hazelcast OS & EE packages

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:
    inputs:
      HZ_VERSION:
        description: 'Version of Hazelcast to build the packages from, this is the Maven version - e.g.: 5.0.2 or 5.1-SNAPSHOT'
        required: true
      PACKAGE_TYPES:
        description: 'Packages to build'
        required: true
        type: choice
        options:
        - all
        - deb
        - rpm
        - homebrew
      RELEASE_TYPE:
        description: 'Which editions should be built'
        required: true
        type: choice
        options:
          - ALL
          - OSS
          - EE
      ENVIRONMENT:
        description: 'Environment to use'
        required: true
        type: environment

env:
  EVENT_NAME: ${{ github.event_name }}
  RELEASE_TYPE_FILE: .github/release_type

concurrency:
  group: '${{ github.workflow }}-${{ github.base_ref || github.ref_name}}'

jobs:
  prepare:
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE: ${{ inputs.RELEASE_TYPE || 'EE' }}
      PACKAGE_TYPES: ${{ inputs.PACKAGE_TYPES || 'all' }}
      HZ_VERSION: ${{ github.event.inputs.HZ_VERSION }}
    outputs:
      hz_version: ${{ steps.hz_version_step.outputs.hz_version }}
      should_build_oss: ${{ steps.resolve-editions.outputs.should_build_oss == 'yes' || github.event_name == 'pull_request' }}
      should_build_ee: ${{ steps.resolve-editions.outputs.should_build_ee == 'yes' || github.event_name == 'pull_request'}}
      should_build_deb: ${{ env.PACKAGE_TYPES == 'all' || env.PACKAGE_TYPES == 'deb' }}
      should_build_rpm: ${{ env.PACKAGE_TYPES == 'all' || env.PACKAGE_TYPES == 'rpm' }}
      should_build_homebrew: ${{ env.PACKAGE_TYPES == 'all' || env.PACKAGE_TYPES == 'homebrew' }}
      ENVIRONMENT: ${{ steps.environment.outputs.ENVIRONMENT }}
      java_version: ${{ steps.default-java-version.outputs.VERSION }}
    steps:
      - name: Checkout hazelcast-packaging repo
        uses: actions/checkout@v5

      - name: Test scripts
        run: |
          ./test_scripts.sh

      - name: Set HZ_VERSION
        id: hz_version_step
        run: |
          if [ -z "${{ env.HZ_VERSION }}" ]; then
            HZ_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          fi
          echo "hz_version=$HZ_VERSION" >> $GITHUB_OUTPUT

      - name: Forbid ${{ env.RELEASE_TYPE_FILE }} file in the PRs
        if: github.event_name == 'pull_request'
        run: |
          if [ -f "${{ env.RELEASE_TYPE_FILE }}" ]; then
            echo "Error: ${{ env.RELEASE_TYPE_FILE }} file is not allowed in the PRs. It's used only during release creation"
            exit 1
          fi

      - name: Read release type from the file
        run: |          
          if [ -f ${{ env.RELEASE_TYPE_FILE }} ]; then
              echo "RELEASE_TYPE=$(cat ${{ env.RELEASE_TYPE_FILE }})" >> $GITHUB_ENV
          else
              echo "File '${{ env.RELEASE_TYPE_FILE }}' does not exist."
          fi

      - id: resolve-editions
        uses: hazelcast/docker-actions/resolve-editions@master
        with:
          release-type: ${{ env.RELEASE_TYPE }}

      - name: Calculate the environment
        id: environment
        run: |
          ENVIRONMENT=${{ (env.EVENT_NAME == 'pull_request' && 'test') || inputs.ENVIRONMENT || 'live' }}
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: Get supported JDKs
        id: jdks
        uses: hazelcast/docker-actions/get-supported-jdks@master
        with:
          HZ_VERSION: ${{ steps.hz_version_step.outputs.hz_version }}

      - name: Get default Java version
        id: default-java-version
        run: |
          # TODO Consider adding this as an output to get-supported-jdks
          echo "VERSION=$(jq --raw-output '.[-1]' <<< '${{ steps.jdks.outputs.jdks }}')" >> ${GITHUB_OUTPUT}

      - name: Add workflow inputs to summary
        run: |
          echo "### Workflow Setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| HZ_VERSION | ${{ steps.hz_version_step.outputs.hz_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PACKAGE_TYPES | ${PACKAGE_TYPES} |" >> $GITHUB_STEP_SUMMARY
          echo "| RELEASE_TYPE | ${RELEASE_TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| ENVIRONMENT | ${{ steps.environment.outputs.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JAVA_VERSION | ${{ steps.default-java-version.outputs.VERSION }} |" >> $GITHUB_STEP_SUMMARY

  # Debian builds
  deb-ee:
    if: needs.prepare.outputs.should_build_deb && needs.prepare.outputs.should_build_ee
    needs: [prepare]
    uses: ./.github/workflows/publish-deb-package.yml
    secrets: inherit
    with:
     HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
     HZ_DISTRIBUTION: hazelcast-enterprise
     ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
     JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
  deb-oss:
    needs: [ prepare ]
    if: needs.prepare.outputs.should_build_deb && needs.prepare.outputs.should_build_oss
    uses: ./.github/workflows/publish-deb-package.yml
    secrets: inherit
    with:
      HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
      HZ_DISTRIBUTION: hazelcast
      ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
      JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
  # RPM builds
  rpm-ee:
    if: needs.prepare.outputs.should_build_rpm && needs.prepare.outputs.should_build_ee
    needs: [prepare]
    uses: ./.github/workflows/publish-rpm-package.yml
    secrets: inherit
    with:
     HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
     HZ_DISTRIBUTION: hazelcast-enterprise
     ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
     JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
  rpm-oss:
    needs: [ prepare ]
    if: needs.prepare.outputs.should_build_rpm && needs.prepare.outputs.should_build_oss
    uses: ./.github/workflows/publish-rpm-package.yml
    secrets: inherit
    with:
      HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
      HZ_DISTRIBUTION: hazelcast
      ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
      JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
  # Homebrew builds
  brew-ee:
    if: needs.prepare.outputs.should_build_homebrew && needs.prepare.outputs.should_build_ee
    needs: [prepare]
    uses: ./.github/workflows/publish-brew-package.yml
    secrets: inherit
    with:
     HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
     HZ_DISTRIBUTION: hazelcast-enterprise
     ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
     JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
  brew-oss:
    needs: [ prepare ]
    if: needs.prepare.outputs.should_build_homebrew && needs.prepare.outputs.should_build_oss && !contains(needs.prepare.outputs.hz_version, 'SNAPSHOT')
    uses: ./.github/workflows/publish-brew-package.yml
    secrets: inherit
    with:
      HZ_VERSION: ${{ needs.prepare.outputs.hz_version }}
      HZ_DISTRIBUTION: hazelcast
      ENVIRONMENT: ${{ needs.prepare.outputs.ENVIRONMENT }}
      JAVA_VERSION: ${{ needs.prepare.outputs.java_version }}
